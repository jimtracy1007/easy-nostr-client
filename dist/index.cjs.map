{"version":3,"file":"index.cjs","sources":["../src/keyUtils.js","../src/nostrClient.js","../src/nostrSdk.js","../index.js"],"sourcesContent":["import { getPublicKey } from 'nostr-tools/pure';\nimport * as nip19 from 'nostr-tools/nip19';\nimport { bytesToHex, hexToBytes } from '@noble/hashes/utils';\n\n/**\n * Determine if a value is an nsec (NIP-19 secret key)\n */\nexport function isNsecKey(value) {\n  return typeof value === 'string' && value.startsWith('nsec1');\n}\n\n/**\n * Determine if a value is an npub (NIP-19 public key)\n */\nexport function isNpubKey(value) {\n  return typeof value === 'string' && value.startsWith('npub1');\n}\n\n/**\n * Convert nsec to Uint8Array\n */\nexport function decodeNsecToBytes(nsecKey) {\n  if (!isNsecKey(nsecKey)) {\n    throw new Error('Invalid nsec key');\n  }\n  const decoded = nip19.decode(nsecKey);\n  return decoded.data;\n}\n\n/**\n * Convert secret key (nsec | hex | Uint8Array) to Uint8Array\n */\nexport function normalizeSecretKey(secret) {\n  if (secret instanceof Uint8Array) {\n    return secret;\n  }\n  if (Buffer.isBuffer(secret)) {\n    return Uint8Array.from(secret);\n  }\n  if (typeof secret === 'string') {\n    if (isNsecKey(secret)) {\n      return decodeNsecToBytes(secret);\n    }\n    if (isHex64(secret)) {\n      return hexToBytes(secret);\n    }\n  }\n  throw new Error('Unsupported secret key format');\n}\n\n/**\n * Convert Uint8Array/Buffer/hex secret key to hex string\n */\nexport function secretToHex(secret) {\n  const bytes = normalizeSecretKey(secret);\n  return bytesToHex(bytes);\n}\n\n/**\n * Convert secret key to nsec string\n */\nexport function encodeSecretToNsec(secret) {\n  const bytes = normalizeSecretKey(secret);\n  return nip19.nsecEncode(bytes);\n}\n\n/**\n * Derive hex public key from secret (nsec | hex | Uint8Array)\n */\nexport function derivePubkeyFromSecret(secret) {\n  const bytes = normalizeSecretKey(secret);\n  return getPublicKey(bytes);\n}\n\n/**\n * Convert npub to hex public key\n */\nexport function decodeNpubToHex(npubKey) {\n  if (!isNpubKey(npubKey)) {\n    throw new Error('Invalid npub key');\n  }\n  const decoded = nip19.decode(npubKey);\n  return decoded.data.toLowerCase();\n}\n\n/**\n * Convert hex/Uint8Array public key to npub\n */\nexport function encodePubkeyToNpub(pubkey) {\n  const hex = publicToHex(pubkey);\n  return nip19.npubEncode(hex);\n}\n\n/**\n * Normalize public key to hex string\n */\nexport function publicToHex(pubkey) {\n  if (pubkey instanceof Uint8Array) {\n    return bytesToHex(pubkey);\n  }\n  if (Buffer.isBuffer(pubkey)) {\n    return Buffer.from(pubkey).toString('hex');\n  }\n  if (typeof pubkey === 'string') {\n    if (isNpubKey(pubkey)) {\n      return decodeNpubToHex(pubkey);\n    }\n    if (isHex64(pubkey)) {\n      return pubkey.toLowerCase();\n    }\n  }\n  throw new Error('Unsupported public key format');\n}\n\nexport function isHex64(value) {\n  return typeof value === 'string' && /^[0-9a-fA-F]{64}$/.test(value);\n}\n\nconst keyUtils = {\n  isNsecKey,\n  isNpubKey,\n  decodeNsecToBytes,\n  normalizeSecretKey,\n  secretToHex,\n  encodeSecretToNsec,\n  derivePubkeyFromSecret,\n  decodeNpubToHex,\n  encodePubkeyToNpub,\n  publicToHex,\n  isHex64,\n};\n\nexport default keyUtils;\n","import { finalizeEvent } from 'nostr-tools/pure';\nimport * as nip04 from 'nostr-tools/nip04';\nimport { SimplePool } from 'nostr-tools/pool';\nimport keyUtils from './keyUtils.js';\n\n/**\n * Nostr Client - sends requests to the SDK backend\n */\nclass NostrClient {\n  constructor(options = {}) {\n    this.relayUrls = options.relays || ['wss://dev-relay.lnfi.network'];\n    this.pool = new SimplePool({ enablePing: true, enableReconnect: true });\n    this.privateKey = options.privateKey\n      ? keyUtils.normalizeSecretKey(options.privateKey)\n      : undefined;\n   this.publicKey = options.publicKey\n         ? keyUtils.publicToHex(options.publicKey)\n         : undefined;\n    this.serverPublicKey = options.serverPublicKey\n         ? keyUtils.publicToHex(options.serverPublicKey)\n         : undefined;\n    this.timeout = options.timeout || 30000;\n  }\n\n  /**\n   * Initialize connection (SimplePool manages connections automatically)\n   */\n  async connect() {\n    // SimplePool connects automatically when subscribing; keep method for compatibility\n    console.log(`Client ready to use relays: ${this.relayUrls.join(', ')}`);\n  }\n\n  /**\n   * Send RPC request\n   */\n  async call(method, params = {}) {\n    return new Promise(async (resolve, reject) => {\n      const requestId = `${Date.now()}-${Math.random()}`;\n      const request = { method, params, id: requestId };\n\n      let subscription;\n      let timeoutId;\n      let settled = false;\n\n      const cleanup = () => {\n        if (timeoutId) {\n          clearTimeout(timeoutId);\n          timeoutId = null;\n        }\n        if (subscription) {\n          subscription.close();\n          subscription = null;\n        }\n      };\n\n      const finalize = (error, result) => {\n        if (settled) return;\n        settled = true;\n        cleanup();\n        if (error) {\n          reject(error);\n        } else {\n          resolve(result);\n        }\n      };\n\n      try {\n        const plaintext = JSON.stringify(request);\n        const encrypted = await nip04.encrypt(\n          this.privateKey,\n          this.serverPublicKey,\n          plaintext\n        );\n\n        const event = {\n          kind: 4,\n          pubkey: this.publicKey,\n          created_at: Math.floor(Date.now() / 1000),\n          tags: [['p', this.serverPublicKey]],\n          content: encrypted,\n        };\n\n        const signed = finalizeEvent(event, this.privateKey);\n\n        timeoutId = setTimeout(() => {\n          finalize(new Error(`Request timeout after ${this.timeout}ms`));\n        }, this.timeout);\n\n        subscription = this.pool.subscribe(\n          this.relayUrls,\n          { kinds: [4], '#p': [this.publicKey], authors: [this.serverPublicKey] },\n          {\n            onevent: async (replyEvent) => {\n              if (settled) return;\n\n              const pTag = replyEvent.tags.find(t => t[0] === 'p');\n              if (!pTag || pTag[1] !== this.publicKey || replyEvent.pubkey !== this.serverPublicKey) {\n                return;\n              }\n\n              try {\n                const decrypted = await nip04.decrypt(\n                  this.privateKey,\n                  this.serverPublicKey,\n                  replyEvent.content\n                );\n                const response = JSON.parse(decrypted);\n\n                if (response.id === requestId) {\n                  if (response.error) {\n                    finalize(new Error(response.error));\n                  } else {\n                    finalize(null, response.result);\n                  }\n                }\n              } catch (err) {\n                console.error('Error decrypting reply:', err.message);\n              }\n            },\n          }\n        );\n\n        await Promise.any(this.pool.publish(this.relayUrls, signed));\n\n        console.log(`Sent ${method}`);\n      } catch (error) {\n        finalize(error);\n      }\n    });\n  }\n\n  /**\n   * Send plain text direct message and wait for reply\n   */\n  async sendMessage(text, recipientPubkey, waitForReply = false) {\n    const recipientPubkeyHex = keyUtils.publicToHex(recipientPubkey);\n\n    return new Promise(async (resolve, reject) => {\n      let subscription;\n      let timeoutId;\n      let settled = false;\n\n      const cleanup = () => {\n        if (timeoutId) {\n          clearTimeout(timeoutId);\n          timeoutId = null;\n        }\n        if (subscription) {\n          subscription.close();\n          subscription = null;\n        }\n      };\n\n      const finalize = (error, result) => {\n        if (settled) return;\n        settled = true;\n        cleanup();\n        if (error) {\n          reject(error);\n        } else {\n          resolve(result);\n        }\n      };\n\n      try {\n        const encrypted = await nip04.encrypt(\n          this.privateKey,\n          recipientPubkeyHex,\n          text\n        );\n\n        const event = {\n          kind: 4,\n          pubkey: this.publicKey,\n          created_at: Math.floor(Date.now() / 1000),\n          tags: [['p', recipientPubkeyHex]],\n          content: encrypted,\n        };\n\n        const signed = finalizeEvent(event, this.privateKey);\n        const sentEventId = signed.id;\n        const sentTimestamp = event.created_at;\n\n        if (!waitForReply) {\n          await Promise.any(this.pool.publish(this.relayUrls, signed));\n          console.log(`Message sent to ${recipientPubkeyHex.slice(0, 8)}`);\n          finalize(null, { success: true, timestamp: sentTimestamp, eventId: sentEventId });\n          return;\n        }\n\n        timeoutId = setTimeout(() => {\n          finalize(new Error(`Reply timeout after ${this.timeout}ms`));\n        }, this.timeout);\n\n        subscription = this.pool.subscribe(\n          this.relayUrls,\n          { kinds: [4], '#p': [this.publicKey], authors: [recipientPubkeyHex], since: sentTimestamp },\n          {\n            onevent: async (replyEvent) => {\n              if (settled) return;\n\n              console.log(`[Client] Received reply event ${replyEvent.id.slice(0, 8)} from ${replyEvent.pubkey.slice(0, 8)}`);\n              console.log(`[Client] Event tags:`, replyEvent.tags);\n              console.log(`[Client] Event content:`, replyEvent);\n\n              try {\n                const pTag = replyEvent.tags.find(t => t[0] === 'p');\n                const eTag = replyEvent.tags.find(t => t[0] === 'e');\n                if (!pTag || pTag[1] !== this.publicKey || replyEvent.pubkey !== recipientPubkeyHex) {\n                  console.log(`[Client] Skipping: p or author mismatch`);\n                  return;\n                }\n                if (eTag && eTag[1] !== sentEventId) {\n                  console.log(`[Client] Skipping: e tag mismatch (expected ${sentEventId.slice(0, 8)}, got ${eTag[1].slice(0, 8)})`);\n                  return;\n                }\n                if (!eTag) {\n                  console.log(`[Client] Warning: Reply has no e tag, accepting anyway`);\n                }\n\n                const decrypted = await nip04.decrypt(\n                  this.privateKey,\n                  recipientPubkeyHex,\n                  replyEvent.content\n                );\n\n                finalize(null, {\n                  success: true,\n                  reply: decrypted,\n                  sender: recipientPubkeyHex,\n                  timestamp: replyEvent.created_at,\n                  eventId: replyEvent.id,\n                });\n              } catch (err) {\n                console.error('Error decrypting reply:', err.message);\n              }\n            },\n          }\n        );\n\n        await Promise.any(this.pool.publish(this.relayUrls, signed));\n        console.log(`Message sent to ${recipientPubkeyHex.slice(0, 8)}, waiting for reply...`);\n      } catch (error) {\n        console.error('Error sending message:', error.message);\n        finalize(error);\n      }\n    });\n  }\n\n  /**\n   * Listen for plain text direct messages from a specific sender\n   */\n  listenForMessages(senderPubkey, onMessage, onError) {\n    const senderPubkeyHex = keyUtils.publicToHex(senderPubkey);\n    const subscription = this.pool.subscribe(\n      this.relayUrls,\n      { kinds: [4], '#p': [this.publicKey], authors: [senderPubkeyHex] },\n      {\n        onevent: async (event) => {\n          try {\n            const pTag = event.tags.find(t => t[0] === 'p');\n            if (!pTag || pTag[1] !== this.publicKey || event.pubkey !== senderPubkey) {\n              return;\n            }\n\n            const decrypted = await nip04.decrypt(\n              this.privateKey,\n              senderPubkeyHex,\n              event.content\n            );\n\n            onMessage({\n              text: decrypted,\n              sender: senderPubkey,\n              timestamp: event.created_at,\n              eventId: event.id,\n            });\n          } catch (err) {\n            console.error('Error decrypting message:', err.message);\n            if (onError) onError(err);\n          }\n        },\n      }\n    );\n\n    return subscription;\n  }\n\n  /**\n   * Close connections\n   */\n  close() {\n    this.pool.close(this.relayUrls);\n  }\n}\n\nexport default NostrClient;\n","import { finalizeEvent } from 'nostr-tools/pure';\nimport * as nip04 from 'nostr-tools/nip04';\nimport { SimplePool } from 'nostr-tools/pool';\nimport { EventEmitter } from 'events';\nimport keyUtils from './keyUtils.js';\n\n/**\n * Nostr SDK - Backend server\n * Listen for direct messages, parse JSON-RPC style requests, call business methods, and return results\n */\nclass NostrSdk extends EventEmitter {\n  constructor(options = {}) {\n    super();\n    this.relayUrls = options.relays || ['wss://dev-relay.lnfi.network'];\n    this.pool = new SimplePool({ enablePing: true, enableReconnect: true });\n    this.privateKey = options.privateKey\n      ? keyUtils.normalizeSecretKey(options.privateKey)\n      : undefined;\n    this.publicKey = options.publicKey\n      ? keyUtils.publicToHex(options.publicKey)\n      : undefined;\n    this.authorWhitelist = Array.isArray(options.allowedAuthors)\n      ? options.allowedAuthors.map(keyUtils.publicToHex)\n      : [];\n    this.methodRegistry = new Map();\n    this.isListening = false;\n    this.subscription = null;\n  }\n\n  /**\n   * Register business methods\n   */\n  registerMethod(method, handler) {\n    if (typeof handler !== 'function') {\n      throw new Error(`Handler for method \"${method}\" must be a function`);\n    }\n    this.methodRegistry.set(method, handler);\n  }\n\n  /**\n   * Start listening\n   */\n  async start() {\n    if (this.isListening) {\n      console.log('Already listening for messages');\n      return;\n    }\n\n    if (!this.privateKey || !this.publicKey) {\n      throw new Error('privateKey and publicKey are required');\n    }\n\n    this.isListening = true;\n    console.log(`Starting Nostr SDK on relays: ${this.relayUrls.join(', ')}`);\n\n    // Use SimplePool to subscribe to direct message events (kind 4)\n    // Use since to only get new messages, not load history\n    const filter = {\n      kinds: [4],\n      since: Math.floor(Date.now() / 1000),\n      '#p': [this.publicKey],\n    };\n\n    if (this.authorWhitelist.length > 0) {\n      filter.authors = this.authorWhitelist;\n    }\n\n    this.subscription = this.pool.subscribe(\n      this.relayUrls,\n      filter,\n      {\n        onevent: (event) => this._handleEvent(event),\n      }\n    );\n\n    console.log(`Subscribed to all relays`);\n    this.emit('started');\n  }\n\n  /**\n   * Handle received events\n   */\n  async _handleEvent(event) {\n    try {\n      console.log(`[SDK] Received event from ${event.pubkey.slice(0, 8)}`);\n      \n      // Check if this message is for us\n      const pTag = event.tags.find(t => t[0] === 'p');\n      if (!pTag || pTag[1] !== this.publicKey) {\n        console.log(`[SDK] Message not for us (expected ${this.publicKey.slice(0, 8)})`);\n        return; // Not a message for us\n      }\n      \n      console.log(`[SDK] Processing message for us`);\n\n      // Decrypt direct message content\n      const decrypted = await nip04.decrypt(this.privateKey, event.pubkey, event.content);\n\n      // Try to parse JSON\n      let request;\n      try {\n        request = JSON.parse(decrypted);\n      } catch (e) {\n        await this._replyError(event.pubkey, 'Invalid JSON format', null);\n        return;\n      }\n\n      // Validate request format\n      if (!request.method) {\n        await this._replyError(event.pubkey, 'Missing method field', null);\n        return;\n      }\n\n      // Call business method\n      const handler = this.methodRegistry.get(request.method);\n      if (!handler) {\n        await this._replyError(event.pubkey, `Method not found: ${request.method}`, request.id);\n        return;\n      }\n\n      const result = await handler(request.params || {}, event);\n\n      // Return result\n      await this._reply(event.pubkey, {\n        id: request.id,\n        result,\n        error: null,\n      });\n    } catch (error) {\n      console.error('Error processing event:', error.message);\n    }\n  }\n\n  /**\n   * Send direct message reply\n   */\n  async _reply(recipientPubkey, data) {\n    try {\n      const plaintext = JSON.stringify(data);\n      const encrypted = await nip04.encrypt(this.privateKey, recipientPubkey, plaintext);\n\n      const event = {\n        kind: 4,\n        pubkey: this.publicKey,\n        created_at: Math.floor(Date.now() / 1000),\n        tags: [['p', recipientPubkey]],\n        content: encrypted,\n      };\n\n      const signed = finalizeEvent(event, this.privateKey);\n\n      // Use SimplePool to publish to all relays\n      await Promise.any(this.pool.publish(this.relayUrls, signed));\n\n      console.log(`Replied to ${recipientPubkey.slice(0, 8)}`);\n    } catch (error) {\n      console.error('Error sending reply:', error.message);\n      this.emit('error', error);\n    }\n  }\n\n  /**\n   * Send error reply\n   */\n  async _replyError(recipientPubkey, message, requestId) {\n    await this._reply(recipientPubkey, {\n      id: requestId,\n      result: null,\n      error: message,\n    });\n  }\n\n  /**\n   * Stop listening\n   */\n  stop() {\n    this.isListening = false;\n\n    // Close subscription\n    if (this.subscription) {\n      this.subscription.close();\n      this.subscription = null;\n    }\n\n    // Close SimplePool\n    this.pool.close(this.relayUrls);\n\n    console.log('SDK stopped');\n    this.emit('stopped');\n  }\n}\n\nexport default NostrSdk;","import NostrClient from './src/nostrClient.js';\nimport NostrSdk from './src/nostrSdk.js';\nimport keyUtils from './src/keyUtils.js';\n\nimport * as nip04 from 'nostr-tools/nip04';\nimport * as nip19 from 'nostr-tools/nip19';\nimport { SimplePool, useWebSocketImplementation } from 'nostr-tools/pool';\nimport {\n  finalizeEvent,\n  verifyEvent,\n  generateSecretKey,\n  getPublicKey,\n} from 'nostr-tools/pure';\nimport { bytesToHex, hexToBytes } from '@noble/hashes/utils';\n\nconst api = {\n  NostrClient,\n  NostrSdk,\n  nip04,\n  nip19,\n  SimplePool,\n  useWebSocketImplementation,\n  finalizeEvent,\n  verifyEvent,\n  generateSecretKey,\n  getPublicKey,\n  bytesToHex,\n  hexToBytes,\n  keyUtils,\n};\n\nexport {\n  NostrClient,\n  NostrSdk,\n  nip04,\n  nip19,\n  SimplePool,\n  useWebSocketImplementation,\n  finalizeEvent,\n  verifyEvent,\n  generateSecretKey,\n  getPublicKey,\n  bytesToHex,\n  hexToBytes,\n  keyUtils,\n};\n\nexport default api;\n"],"names":["isNsecKey","value","isNpubKey","decodeNsecToBytes","nsecKey","nip19","normalizeSecretKey","secret","isHex64","hexToBytes","secretToHex","bytes","bytesToHex","encodeSecretToNsec","derivePubkeyFromSecret","getPublicKey","decodeNpubToHex","npubKey","encodePubkeyToNpub","pubkey","hex","publicToHex","keyUtils","NostrClient","options","SimplePool","method","params","resolve","reject","requestId","request","subscription","timeoutId","settled","cleanup","finalize","error","result","plaintext","encrypted","nip04","event","signed","finalizeEvent","replyEvent","pTag","t","decrypted","response","err","text","recipientPubkey","waitForReply","recipientPubkeyHex","sentEventId","sentTimestamp","eTag","senderPubkey","onMessage","onError","senderPubkeyHex","NostrSdk","EventEmitter","handler","filter","data","message","api","useWebSocketImplementation","verifyEvent","generateSecretKey"],"mappings":"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"}